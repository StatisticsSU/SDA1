---
title: "Statistik och dataanalys I, 15 hp "
subtitle: "Inl칛mningsuppgift 2, 1.5 hp"
author: 
- Mattias Villani
date: last-modified
format: 
  html:
    self-contained: true
  pdf: default  
  docx: default
toc: true
language: 
  title-block-author-single: " "
toc-title-document: "Inneh친ll"
crossref-fig-title: "Figur"
theme: Superhero
title-block-banner-color: Primary
title-block-published: "Publicerad"
callout-warning-caption: "Varning"
callout-note-caption: "Observera"
callout-tip-caption: "Tips"
editor: visual
---

::: callout-warning
## Installation av n칬dv칛ndiga paket

Den h칛r inl칛mningsuppgiften f칬ruts칛tter att f칬ljande paket finns installerade:

-   `mosaic`

-   `gplots`

-   `remotes`

-   `sda123`

De tre f칬rsta paketen kan installeras som vanligt via kommandot `install.packages('packagename')`, d칛r `'packagename'` 칛r namnet p친 paketet, t.ex `'mosaic'`.

Det sista paketet, `sda123`, 칛r SDA-kursernas egna R-paket och installeras med kommandot

`install_github("StatisticsSU/sda123")`

**efter** att du laddat in `remotes` paketet.
:::

```{r}
#| echo: false
#| output: false
suppressMessages(library(mosaic))
suppressMessages(library(gplots))
suppressMessages(library(remotes))
#install_github("StatisticsSU/sda123")
suppressMessages(library(sda123))
```

## Introduktion

I denna andra inl칛mningsuppgift ska ni sj칛lvst칛ndigt i grupper om tre analysera ett datamaterial i programmeringsspr친ket R, med fokus p친 sannolikhetsl칛ra och inferens. Till skillnad fr친n datorlaborationerna finns det minimalt med kodexempel. Datorlaborationerna g친r igenom de flesta momenten som behandlas i inl칛mningsuppgiften, s친 se till att g칬ra klart dessa innan.

------------------------------------------------------------------------

::: callout-note
### Instruktioner

I denna inl칛mningsuppgift ska ni analysera ett datamaterial med 1602 australiska hush친lls elkonsumption[^1], och finns i kursens R-paket `sda123` och heter `electricitycost`. N칛r du installerat och laddat in `sda123`-paketet finns `electricitycost` tillg칛ngligt som en dataframe, dvs en tabell d칛r raderna 칛r observationer (hush친ll) och kolumnerna 칛r variabler, t ex hush친llets kostnad f칬r el och information om hush친llets storlek och utrustning. Se nedan f칬r mer information.

Till skillnad fr친n den tidigare inl칛mningsuppgiften **ska ni i denna inl칛mningsuppgift arbeta i ett separat Quarto-dokument d칛r ni skriver alla svar**. Det h칛r dokumentet som du l칛ser nu inneh친ller allts친 bara instruktioner och fr친gorna. Det Quarto-dokument som ni ska g칬ra analysen och skriva svaren i finns [h칛r](https://github.com/StatisticsSU/SDA1/raw/main/assignments/assignment2/Assignment2handin.qmd "Quartodokument f칬r inl칛mning").

I m친nga uppgifter vill jag att ni ska anv칛nda b친de formelsamlingen f칬r att ber칛kna en sak (t ex ett hypotestest), men 칛ven f칛rdiga funktioner i R (t ex `t.test` funktionen). N칛r ni anv칛nder formelsamlingen f친r ni anv칛nda R f칬r att ber칛kna de saker ni beh칬ver i formlerna, t ex `sd`-funktionen f칬r att ber칛kna standardavvikelsen, eller `qt`-funktionen f칬r att ber칛kna ett kritiskt v칛rde fr친n *t*-f칬rdelningen. P친 det s칛ttet tr칛nas ni b친de p친 att hantera och f칬rst친 formeln (tentan! 游땷) och hur man anv칛nder R i praktiken 游땘. Det kan ocks친 vara bra tr칛ning att leta upp alla kritiska v칛rden i tabellerna, 칛ven om jag inte ber om det.

Inl칛mningsuppgiften ska l칛mnas in i form av ett html dokument genererat av Quarto. **Kontrollera noga att du inte har n친gra felmeddelande och att dokumentet kompileras utan problem**. Anv칛nd tydliga figurer och namnge axlarna med tydliga variabelnamn. Gl칬m inte att skriva era namn i Quarto-dokumentet ist칛llet f칬r Namn 1, Namn 2 och Namn 3.

::: {style="color: red;"}
**Alla gruppmedlemmar ska vara delaktiga och bidra till alla delar av rapporten och arbetet som leder upp till rapporten, dvs skriva kod, analysera data, tolka resultat, dra slutsatser och skriva rapporten.**
:::
:::

[^1]: Bartels, R., Fiebig, D. and Plumb, M. (1996). Gas or electricity, which is cheaper? An econometric approach with application to Australian expenditure data, The Energy Journal 17(4): 33--58.

## 0. L칛sa in data

Datamaterialet `electricitycost` l칛ses in via kurspaketet `sda123`:

```{r}
library(remotes)
#install_github("StatisticsSU/sda123")
library(sda123)
head(electricitycost)
```

Varje rad i datamaterialet 칛r ett av de 1602 australiska hush친llen. Skriv `?electricitycost` i Console f칬r att f친 en komplett beskrivning av alla variabler. F칬r att inte beh칬va skriva det l친nga namnet `electricitycost` hela tiden kan vi definera en ny variabel `df` (f칬rkortning av dataframe)

```{r}
df = electricitycost
```

## 1. Poisson-modell f칬r antal personer i hush친llet

#### 游눩 Uppgift 1.1

Variabeln `people` inneh친ller antal personer i hush친llet. Definiera variabeln `extrapeople = df$people - 1`, som m칛ter antalet personer *ut칬ver* 칛garen (som vi antar 칛r bara en person). I den h칛r uppgiften ska vi modellera `extrapeople` som oberoende observationer fr친n en $\mathrm{Pois}(\lambda)$-f칬rdelning. Skatta parametern $\lambda$ fr친n datamaterialet.

#### 游눩 Uppgift 1.2

Unders칬k grafiskt om den skattade Poisson-modellen i Uppgift 1.1 anpassar data v칛l.

#### 游눩 Uppgift 1.3

Anv칛nd den skattade Poisson-modellen f칬r att ber칛kna sannolikheten f칬r ett storhush친ll, vilket vi definierar som ett hush친ll med fler 칛n 4 personer.

#### 游눩 Uppgift 1.4

Poissonmodellen 칛r en trevlig modell f칬r r칛knedata, men 칛r begr칛nsad eftersom v칛ntev칛rdet och variansen alltid m친ste vara lika in en Poissonf칬rdelning. Verkar det vara ett problem f칬r variabeln `extrapeople`?

## 2. (log)-normalmodell f칬r elkostnad

Hush친llens totala elkostnad, `cost`, 칛r rej칛lt skev:

```{r}
hist(df$cost, 30, freq = FALSE, col = "steelblue")
```

Logaritmen av `cost` har en f칬rdelning som 칛r mycket mer symmetrisk, 칛ven om viss skevhet verkar kvarst친:

```{r}
hist(log(df$cost), 30, freq = FALSE, col = "orange")
```

#### 游눩 Uppgift 2.1

I den h칛r uppgiften ska vi modellera variabeln `logcost = log(df$cost)` som oberoende observationer fr친n en $N(\mu,\sigma)$ f칬rdelning. Skatta $\mu$ och $\sigma$ fr친n data. \[Obs! Ni beh칬ver inte transformera tillbaka till originalskala, utan arbeta med hela Uppgift 2 p친 log-skala.\]

#### 游눩 Uppgift 2.2

Unders칬k grafiskt hur v칛l den skattade normalmodellen passar variabeln `logcost`.

#### 游눩 Uppgift 2.3

J칛mf칬r median av variabeln `logcost` med medianen fr친n den skattade sannolikhetsmodellen fr친n Uppgift 2.1. \[hint: l칬sningen blir v칛ldigt enkel h칛r, det 칛r meningen. Jag vill att ni ska t칛nka p친 kopplingen mellan den teoretiska sannolikhetsmodellen och hur den relaterar till data.\]

#### 游눩 Uppgift 2.4

G칬r ett 95%-igt konfidensintervall f칬r $\mu$ i modellen f칬r `logcost` fr친n Uppgift 2.1, **b친de** genom att anv칛nda formelsamlingen och genom att anv칛nda en funktion i R. Tolka intervallet. \[Som jag skrev i instruktionerna ovan 칛r det ok att anv칛nda R f칬r att ber칛kna delar av konfidensintervallet 칛ven i fallet d칛r jag ber om att ni ska anv칛nda formelsamling; t ex anv칛nda `sd()`-funktionen f칬r att ber칛kna standardavvikelsen `s`. Men jag vill att ni anv칛nder formeln f칬r konfidensintervall fr친n formelsamlingen i den slutliga utr칛kningen. F칬r att tr칛na inf칬r tentan. Och sen j칛mf칬ra med det konfidensintervall ni f친r direkt fr친n R\].

#### 游눩 Uppgift 2.5

Testa om den genomsnittliga `logcost` i modellen/populationen 칛r mindre 칛n 6. St칛ll upp noll- och alternativhypotes och testa p친 5% signifikansniv친. G칬r ber칛kningarna b친de med hj칛lp av formelsamlingen och med R.

#### 游눩 Uppgift 2.6

Ber칛kna *p*-v칛rdet f칬r testet i Uppgift 2.5 genom att anv칛nda R. Hade du f칬rkastat nollhypotesen p친 1% signifikansniv친?

#### 游눩 Uppgift 2.7

Antag att vi tar den skevheten som vi ser i histogrammet 칬ver `logcost` p친 allvar. Beskriv (inga utr칛kningar) om vi 칛nd친 kan g칬ra ett hypotestest utan att anta att `logcost` 칛r normalf칬rdelad.

#### 游눩 Uppgift 2.8

Testa p친 5% signifikansniv친 om det finns n친gon skillnad i genomsnittlig `logcost` i modell/populationen f칬r hush친ll med och utan air conditioner. St칛ll upp noll- och mothypotest och ber칛kna teststatistikans v칛rde med hj칛lp av formelsamlingen. Anv칛nd R f칬r att ber칛kna frihetsgraderna i nollhypotesens *t*-f칬rdelning (som 칛r en komplicerad ber칛kning eftersom vi har olika antal observationer i de tv친 grupperna).

## 3. Enkel och multipel linj칛r regression

Ni ska nu analysera en regressionsmodell med `logcost` som responsvariabel. Vi b칬rjar med hush친llets inkomst `income` som f칬rklarande variabel. Det 칛r sv친rt att se om en linj칛r regression passar data eftersom `income` bara kan anta ett mindre antal v칛rden (den verkar vara grupperad i inkomstklasser):

```{r}
df$logcost = log(df$cost) # l칛gger in logcost i dataframen, blir mindre kod d친.
plot(logcost ~ income, data = df, pch = 19, cex = 0.5, col = "steelblue")
```

F칬r att l칛ttare se om det verkar linj칛rt anpassar jag en s k *lowess*-skattning (en slags icke-linj칛r regression) och plottar anpassningen, med funktionen `plotLowess` fr친n `gplots` paketet:

```{r}
plotLowess(logcost ~ income, data = df, pch = 19, cex = 0.5, col = "steelblue")
```

Det ser inte linj칛rt ut. L친t oss prova att g친 ett steg ned친t p친 Tukey's transformationsstege (i Tukey's cirkel 칛r vi i 칬vre v칛nstra kvadraten, vilket indikerar att vi ska g친 ned친t p친 stegen f칬r X-variabeln) och g칬ra en $\sqrt{ }$ -transformation (sqrt):

```{r}
plotLowess(logcost ~ sqrt(income), data = df, pch = 19, cex = 0.5, col = "steelblue")
```

Hmm, inte riktigt linj칛rt 칛nnu. Vi provar ett steg till ned p친 Tukey's stege, dvs att logaritmera x-variabeln `income` :

```{r}
plotLowess(logcost ~ log(income), data = df, pch = 19, cex = 0.5, col = "steelblue")
```

Bingo! R칛tt s친 linj칛rt! Vi k칬r p친 detta och l칛gger 칛ven in logaritmen av `income` i v친r dataframe `df`.

```{r}
df$logincome = log(df$income)
head(df)
```

#### 游눩 Uppgift 3.1

Anv칛nd R f칬r att skatta modellen:

$$
\texttt{logcost} = \beta_0 + \beta_1 \cdot \texttt{logincome} + \varepsilon, \hspace{1cm} \varepsilon\overset{iid}{\sim}N(0,\sigma_{\varepsilon})
$$

och tolka skattningarna $b_0$ och $b_1$.

#### 游눩 Uppgift 3.2

Anv칛nd formelsamlingen f칬r att ber칛kna ett 99%-igt konfidensintervall f칬r $\beta_1$. Kontrollera att ditt svar st칛mmer med R's direkta ber칛kning av detta konfidensintervall.

#### 游눩 Uppgift 3.3

Anv칛nd formelsamlingen f칬r att testa om `logincome` 칛r en signifikant f칬rklarande variabel p친 signifikansniv친n 1%. St칛ll upp noll- och alternativhypotes f칬r testet och var noga med att dra en slutsats fr친n testet.

#### 游눩 Uppgift 3.4

G칬r en prediktion med 95% prediktionsintervall f칬r `logcost` vid `logincome=11` genom att anv칛nda R. \[tips: argumentet `newdata` i `predict`-funktionen m친ste vara en dataframe, inte en vektor. Se min [kod f칬r lifespan data](https://statisticssu.github.io/SDA1/code/lifespan_regression.R).\]

#### 游눩 Uppgift 3.5

Skatta nu en multipel linj칛r regression:

$$
\texttt{logcost} = \beta_0 
+\beta_1 \cdot \texttt{logincome}
+\beta_2 \cdot \texttt{logrooms}
+\beta_3 \cdot \texttt{logpeople} \\
+\beta_4 \cdot \texttt{onlysecondary}
+\beta_5 \cdot \texttt{poolfilt}
+\beta_6 \cdot \texttt{aircond} 
+ \varepsilon, \hspace{1cm} \varepsilon\overset{iid}{\sim}N(0,\sigma_{\varepsilon})
$$

d칛r `logrooms = log(rooms)` och `logpeople = log(people)` (l칛gg till dessa transformerade variabler i v친r dataframe `df`). Tolka skattningarna av koefficienterna $\beta_1$ och $\beta_6$.

#### 游눩 Uppgift 3.6

Vilka f칬rklarande variabler 칛r signifikanta p친 5% niv친n? P친 1% signifikansniv친?

#### 游눩 Uppgift 3.7

G칬r en prediktion med 90% prediktionsintervall f칬r `logcost` f칬r ett hush친ll med medianv칛rden p친 `logincome`, `logrooms`, `logpeople` och alla tre dummyvariabler satta till v칛rdet noll.

## F칬rdjupning/kuriosa

En av mina doktorander, [Feng Li](https://feng.li/), har tillsammans med mig och professor [Robert Kohn](https://www.unsw.edu.au/staff/robert-kohn) vid UNSW i Sydney analyserat det h칛r datamaterialet i hans doktorsavhandling[^2] vid statistiska institutionen vid SU. Feng utvecklade en flexibel regressionsmodell med f칬rdelningar f칬r feltermerna som bl a till친ts ha:

[^2]: Li, F. (2013). *Bayesian Modeling of Conditional Densities*. Doktorsavhandling vid Statistiska institutionen, Stockholms universitet.

-   heteroskedastisk varians (dvs olika varians f칬r olika v칛rden p친 t ex `logincome`)

-   tunga svansar (likt *t*-f칬rdelningen)

-   skevhet

Hela artikeln 칛r publicerad som ett kapitel in en bok[^3], men finns 칛ven fritt tillg칛nglig som ett [working paper](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1711194).

[^3]: Li, F., Villani, M. och Kohn, R. (2011). Modeling Conditional Densities Using Finite Smooth Mixtures, kapitel i boken *Mixtures: Estimation and Applications* (redakt칬rer:Mengersen, K., Robert, C. och Titterington, M.). Wiley.

H칛r 칛r en bild fr친n avhandlingen, d칛r man ser den prediktiva sannolikhetsf칬rdelningen f칬r `cost` f칬r olika v칛rden p친 `logrooms`, f칬r tre olika varianter av modellen (svarta och r칬da streckade linjer). Genom att utveckla en modell som kan modellera skevhet beh칬vde vi inte transformera `cost` innan analysen, vilket blir trevligare att tolka.

![](LiEtAl.png)
